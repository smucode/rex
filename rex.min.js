(function(){var e=this._||require("underscore"),t=this.Backbone||require("backbone"),n,e;n=function(){function t(e){this.pieces={},this.activeColor=null,this._parse(e||this.DEFAULT_BOARD)}return t.prototype.DEFAULT_BOARD="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",t.prototype.move=function(e,t){return this._validateMove(e,t),this._updateActiveColor(),this._updateCastling(e,t),this._updateEnPassant(e,t),this._updateHalfmoveClock(e,t),this._updateFullmoveNumber(),this._updatePiecePlacement(e,t)},t.prototype.canCastle=function(t){return e.include(this.castling,t)},t.prototype._validateMove=function(e,t){var n;n=this.pieces[e];if(!n)throw new Error("You must select a valid piece to move: "+e)},t.prototype._updateFullmoveNumber=function(){if(this.activeColor==="w")return this.fullmove++},t.prototype._updateHalfmoveClock=function(e,t){var n;return n=this.pieces[e],this._isPawn(n)||this.pieces[t]?this.halfmove=0:this.halfmove++},t.prototype._updateEnPassant=function(e,t){var n,r,i;i=this.pieces[e];if(this._isPawn(i))if(this.enPassant===t)n=t.charAt(1)-e.charAt(1),delete this.pieces[t.charAt(0)+(t.charAt(1)-n)];else{r=t.charAt(1)-e.charAt(1);if(Math.abs(r)===2){this.enPassant=t.charAt(0)+(parseInt(e.charAt(1),10)+r/2);return}}return this.enPassant="-"},t.prototype._updateCastling=function(t,n){if(!this.castling.length)return!1;switch(t){case"a1":return this.castling=e.without(this.castling,"Q");case"a8":return this.castling=e.without(this.castling,"q");case"h1":return this.castling=e.without(this.castling,"K");case"h8":return this.castling=e.without(this.castling,"k");case"e1":return n==="g1"&&e.contains(this.castling,"K")?(this.pieces.f1=this.pieces.h1,delete this.pieces.h1):n==="c1"&&e.contains(this.castling,"Q")&&(this.pieces.d1=this.pieces.a1,delete this.pieces.a1),this.castling=e.without(this.castling,"Q","K");case"e8":return n==="g8"&&e.contains(this.castling,"k")?(this.pieces.f8=this.pieces.h8,delete this.pieces.h8):n==="c8"&&e.contains(this.castling,"q")&&(this.pieces.d8=this.pieces.a8,delete this.pieces.a8),this.castling=e.without(this.castling,"q","k")}},t.prototype._updatePiecePlacement=function(e,t){var n;return n=this.pieces[e],delete this.pieces[e],!this._isPawn(n)||t.charAt(1)!=="1"&&t.charAt(1)!=="8"?this.pieces[t]=n:this.pieces[t]=n==="P"?"Q":"q"},t.prototype._isPawn=function(e){return e==="p"||e==="P"},t.prototype._updateActiveColor=function(){return this.activeColor=this.activeColor==="w"?"b":"w"},t.prototype._parse=function(e){var t;t=e.split?e.split(" "):[];if(!t||t.length!==6)throw new Error("A FEN must contain 6 space separated fields: "+e);return this._parsePiecePlacement(t[0]),this._parseActiveColor(t[1]),this._parseCastling(t[2]),this._parseEnPassant(t[3]),this._parseHalfmoveClock(t[4]),this._parseFullmoveNumber(t[5])},t.prototype._parsePiecePlacement=function(t){var n,r,i,s=this;n=t.split("/");if(n.length!==8)throw new Error("A FEN must contain 8 ranks separated by /: "+t);return r="abcdefgh",i="87654321",e.each(n,function(t,n){var o;return o=0,e.each(t.split(""),function(e,t){var u;return e.match(/[0-8]/)?o+=parseInt(e,10):(u=r.charAt(o)+i.charAt(n),s.pieces[u]=e,o++)})})},t.prototype._parseActiveColor=function(e){if(e==="w"||e==="b")return this.activeColor=e;throw new Exception("Illegal active color: "+e)},t.prototype._parseCastling=function(e){if(e.match(/[kqKQ\-].*/))return this.castling=e.split("");throw new Error("Illegal castling string: "+e)},t.prototype._parseEnPassant=function(e){return this.enPassant=e},t.prototype._parseHalfmoveClock=function(e){return this.halfmove=parseInt(e,10)},t.prototype._parseFullmoveNumber=function(e){return this.fullmove=parseInt(e,10)},t.prototype.toString=function(){var e;return e=this._readPlacement(),e+=" "+this._readColourToMove(),e+=" "+this._readCastling(),e+=" "+this._readEnPassant(),e+=" "+this._readHalfMoves(),e+=" "+this._readFullMoves(),e},t.prototype._readPlacement=function(){var t,n,r=this;return n="",t={},e.each(e.range(8,0,-1),function(t){var i;i=0,e.isEmpty(n)||(n+="/"),e.each(["a","b","c","d","e","f","g","h"],function(s){var o,u,a;return u=e.keys(r.pieces),a=s+t,e.include(u,a)?(o=r.pieces[a],n+=i>0?i+o:o,i=0):i++});if(i)return n+=i}),n},t.prototype._readColourToMove=function(){return this.activeColor},t.prototype._readCastling=function(){return this.castling.length?this.castling.join(""):"-"},t.prototype._readEnPassant=function(){return this.enPassant},t.prototype._readHalfMoves=function(){return this.halfmove},t.prototype._readFullMoves=function(){return this.fullmove},t}();var r,e;r=function(){function t(){this.attacks=[]}return t.prototype.types={PAWN:1,KNIGHT:2,KING:3,BISHOP:5,ROOK:6,QUEEN:7},t.prototype.canCapture=function(e){var t;return t=this.board._getPieceAt(e),t&&t.color!==this.color},t.prototype.canMoveTo=function(e){var t;return t=this.board._getPieceAt(e),!t&&this.board.isOnBoard(e)},t.prototype.addDirectionalMoves=function(t){var n=this;return this.moves=[],this.checks=[],this.attacks=[],this.pinning={},this.behindKing=null,e.each(t,function(e){return n._addNextDirectionalMove(e)}),this._removePinnedMoves(),this._removeMovesNotHelpingCheckedKing()},t.prototype._removePinnedMoves=function(){var t;if(this.color===this.board._getCurrentColor()){t=this.board.isPinned(this.idx);if(t)return this.moves=e.intersection(this.moves,t)}},t.prototype._addNextDirectionalMove=function(e,t){var n;t=t||1,n=this.idx+t*e;if(this.canMoveTo(n))return this.moves.push(n),this.attacks.push(n),this._addNextDirectionalMove(e,++t);this.canCapture(n)&&(this.moves.push(n),this._checkPinning(n,e,t),this._checkKingAttacks(n,e,t));if(this.board.isOnBoard(n))return this.attacks.push(n)},t.prototype._removeMovesNotHelpingCheckedKing=function(){var t;if(this.color===this.board._getCurrentColor()){t=this.board.getCheckingPieces();if(t.length===1)return this.moves=e.intersection(this.moves,t[0].checks);if(t.length>1)return this.moves=[]}},t.prototype._checkKingAttacks=function(e,t,n){var r;r=this.board._getPieceAt(e);if(r.type===3)return this.checks=[],this._setMoveBehindKing(t,n),this._backtrackPinnedMoves(t,--n,this.checks)},t.prototype._checkPinning=function(e,t,n){var r,i;i=this.idx+(n+1)*t;if(this.canMoveTo(i))return this._checkPinning(e,t,++n);if(this.canCapture(i)){r=this.board._getPieceAt(i);if(r.type===3&&r.color!==this.color)return this.pinning[e]=[],this._backtrackPinnedMoves(t,n,this.pinning[e])}},t.prototype._setMoveBehindKing=function(e,t){var n;n=this.idx+(t+1)*e;if(this.canMoveTo(n))return this.behindKing=n},t.prototype._backtrackPinnedMoves=function(e,t,n){var r;r=this.idx+t*e,n.push(r);if(r!==this.idx)return this._backtrackPinnedMoves(e,--t,n)},t.prototype.is=function(e){return this.types[e]===this.type},t}();var r,i,e,s={}.hasOwnProperty,o=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};i=function(e){function t(e,t,n){this.idx=e,this.color=t,this.board=n,this.moves=[]}return o(t,e),t.prototype.DIRECTIONS=[1,-1,16,-16],t.prototype.calculate=function(){return this.addDirectionalMoves(this.DIRECTIONS)},t}(r);var u,r,e,s={}.hasOwnProperty,o=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};u=function(t){function n(e,t,n){this.idx=e,this.color=t,this.board=n,this.moves=[]}return o(n,t),n.prototype.DIRECTIONS=[14,18,31,33,-18,-14,-33,-31],n.prototype.calculate=function(){return this.moves=[],this.checks=[],this.attacks=[],this.pinning={},this.behindKing=null,this._addRegularMoves(),this._removePinnedMoves(),this._removeMovesNotHelpingCheckedKing()},n.prototype._addRegularMoves=function(){var t=this;return e.each(this.DIRECTIONS,function(e){var n,r;r=t.idx+e,(t.canMoveTo(r)||t.canCapture(r))&&t.moves.push(r),t.canCapture(r)&&(n=t.board._getPieceAt(r),n.color!==t.color&&n.type===3&&(t.checks=[t.idx]));if(t.board.isOnBoard(r))return t.attacks.push(r)})},n}(r);var a,r,e,s={}.hasOwnProperty,o=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};a=function(e){function t(e,t,n){this.idx=e,this.color=t,this.board=n,this.moves=[]}return o(t,e),t.prototype.OFFSETS=[15,17,-17,-15],t.prototype.calculate=function(){return this.addDirectionalMoves(this.OFFSETS)},t}(r);var f,r,e,s={}.hasOwnProperty,o=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};f=function(t){function n(e,t,n){this.idx=e,this.color=t,this.board=n,this.type=3,this.moves=[],this.attacks=[],this.behindKing=null,this._castlingIdx=this.color===1?4:116,this._castling=this.color===1?{Q:-1,K:1}:{q:-1,k:1}}return o(n,t),n.prototype.CASTLE_SQUARES={q:[-1,-2,-3],k:[1,2]},n.prototype.DIRECTIONS=[-1,1,15,16,17,-17,-16,-15],n.prototype.calculate=function(){return this.moves=[],this.checks=[],this.attacks=[],this.pinning={},this._addRegularMoves(),this._addCastlingMoves()},n.prototype.canCastle=function(e,t){var n;return n=this.idx===this._castlingIdx&&this.board.canCastle(e),n?!this._pathToRookIsBlocked(e):!1},n.prototype._pathToRookIsBlocked=function(t){var n=this;return e.find(this.CASTLE_SQUARES[t.toLowerCase()],function(e){var t;return t=n.idx+e,!n.canMoveTo(t)||n.isAttacked(t)})},n.prototype.isAttacked=function(e){return this.board.isAttacked(e)},n.prototype.isProtected=function(e){return this.board.isProtected(e)},n.prototype._addRegularMoves=function(){var t=this;return e.each(this.DIRECTIONS,function(e){var n;n=t.idx+e,t.isSquareBehindCheckedKing(n)||(t.canMoveTo(n)&&!t.isAttacked(n)||t.canCapture(n)&&!t.isProtected(n))&&t.moves.push(n);if(t.board.isOnBoard(n))return t.attacks.push(n)})},n.prototype.isSquareBehindCheckedKing=function(t){var n,r=this;return n=this.board._getCurrentColor(),e.detect(this.board._getPieces(n*-1),function(e){return e.behindKing===t})},n.prototype._addCastlingMoves=function(){var t=this;return e.each(this._castling,function(e,n){if(t.canCastle(n))return t.moves.push(t.idx+e*2)})},n}(r);var r,l,e,s={}.hasOwnProperty,o=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};l=function(e){function t(e,t,n){this.idx=e,this.color=t,this.board=n,this.moves=[]}return o(t,e),t.prototype.OFFSETS=[-1,1,15,16,17,-17,-16,-15],t.prototype.calculate=function(){return this.addDirectionalMoves(this.OFFSETS)},t}(r);var c,r,e,s={}.hasOwnProperty,o=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};c=function(t){function n(e,t,n){this.idx=e,this.color=t,this.board=n,this.moves=[],this.type=1}return o(n,t),n.prototype._CAPTURE_DIRECTIONS=[1,-1],n.prototype.calculate=function(){return this.moves=[],this.checks=[],this.attacks=[],this.pinning={},this.behindKing=null,this._addRegularMoves(),this._addCaptureMoves(),this._removePinnedMoves(),this._removeMovesNotHelpingCheckedKing()},n.prototype.canCaptureEnPassant=function(e){return this.board.isEnPassant(e)},n.prototype._addRegularMoves=function(){var e;e=this.idx+this.color*16;if(this.board.isOnBoard(e)&&this.board.isEmpty(e)){this.moves.push(e);if(this.color===1&&this.idx>=16&&this.idx<24||this.color===-1&&this.idx>=96&&this.idx<104){e=this.idx+this.color*32;if(this.board.isEmpty(e))return this.moves.push(e)}}},n.prototype._addCaptureMoves=function(){var t=this;return e.each(this._CAPTURE_DIRECTIONS,function(e){var n,r;r=t.idx+t.color*16+e,(t.canCapture(r)||t.canCaptureEnPassant(r))&&t.moves.push(r),t.canCapture(r)&&(n=t.board._getPieceAt(r),n.color!==t.color&&n.type===3&&(t.checks=[t.idx]));if(t.board.isOnBoard(r))return t.attacks.push(r)})},n}(r);var a,h,p,f,u,c,l,i;h={PAWN:1,KNIGHT:2,KING:3,BISHOP:5,ROOK:6,QUEEN:7,WHITE:1,BLACK:-1},p=function(){function e(){}return e.prototype._instanceArr=[null,c,u,f,null,a,i,l],e.prototype._pieceMap={r:h.BLACK*h.ROOK,n:h.BLACK*h.KNIGHT,b:h.BLACK*h.BISHOP,q:h.BLACK*h.QUEEN,k:h.BLACK*h.KING,p:h.BLACK*h.PAWN,R:h.WHITE*h.ROOK,N:h.WHITE*h.KNIGHT,B:h.WHITE*h.BISHOP,Q:h.WHITE*h.QUEEN,K:h.WHITE*h.KING,P:h.WHITE*h.PAWN},e.prototype.create=function(e,t,n){var r,i,s;s=this._pieceMap[e],i=s>0?h.WHITE:h.BLACK,r=this._instanceArr[Math.abs(s)];if(r)return new r(t,i,n);throw new Error("Unable to create piece "+e)},e}();var t,d,p,n,e;d=function(){function r(r){var i=this;e.extend(this,t.Events),this._state={},this._fen=new n(r),this._board=new Array(128),this.factory=new p,e.each(this._fen.pieces,function(e,t){var n;return n=i._posToIdx(t),i._board[n]=i.factory.create(e,n,i)}),this._calculate()}return r.prototype.WHITE=1,r.prototype.BLACK=-1,r.prototype._state="move",r.prototype._files="abcdefgh",r.prototype.move=function(e,t){var n,r;n=this._getPiece(e),this._verifyMove(n),r=this._posToIdx(t),this._verifyIndex(n,r),this._state={};if(!n.canCapture(r)&&!n.canMoveTo(r))throw new Error("unable to move from "+e+" to "+t);return n.is("PAWN")&&(r<9||r>111)?this._promotePawn(e,t,n,r):(this._fen.enPassant===t&&this._moveEnPassant(t,e),this._updateArray(e,t),this._fen.move(e,t)),this._fen.halfmove>=50?this._state.finished="halfmoves":this._calculate(),this._state.to=t,this._state.from=e,this._fireEvent(),this._state},r.prototype._verifyMove=function(e){if(!e)throw new Error("there is no piece to move");if(this._getCurrentColor()!==e.color)throw new Error("cannot move out of order")},r.prototype._verifyIndex=function(e,t){if(e.moves.indexOf(t)===-1)throw new Error("there is no piece at "+this._idxToPos(t)+": "+this._fen.toString())},r.prototype._promotePawn=function(e,t,n,r){var i,s;return this._fen.move(e,t),i=this._posToIdx(e),this._board[i]=null,s=n.color===1?"Q":"q",this._board[r]=this.factory.create(s,r,this),this._state.promotion=s},r.prototype._moveEnPassant=function(e,t){return this._state.enPassantCapture=e[0]+t[1]},r.prototype._fireEvent=function(){return this.trigger("move",this._state)},r.prototype.onMove=function(e){return this.on("move",e),e(this.getState())},r.prototype.getState=function(){return this._state},r.prototype._calculateValidMoves=function(){var t,n=this;return t={},e.each(this._getPieces(this._getCurrentColor()),function(r){var i;if(r.moves.length>0)return i=e.map(r.moves,function(e){return n._idxToPos(e)}),t[n._idxToPos(r.idx)]=i}),t},r.prototype._posToIdx=function(e){var t;if(!e||typeof e!="string"||!e.match(/[a-h]{1}[0-8]{1}/))throw new Error("illegal pos "+e);return t=this._files.indexOf(e[0]),t+(e[1]-1)*16},r.prototype._idxToPos=function(e){var t,n,r;t=e%16,r=Math.floor(e/16),n=this._files[t]+(r+1);if(typeof n!="string")throw new Error("illegal idx "+e);return n},r.prototype._getPieceAt=function(e){return this._board[e]},r.prototype._getPieces=function(t){return e.filter(this._board,function(e){return t?e&&e.color===t:e})},r.prototype._getPiece=function(e){var t;return t=this._posToIdx(e),this._getPieceAt(t)},r.prototype._getCurrentColor=function(){return this._fen.activeColor==="w"?this.WHITE:this.BLACK},r.prototype._calculate=function(){var t,n,r,i=this;return n=this._getCurrentColor(),r=[],t=[],e.each(this._getPieces(n*-1),function(n){return n.calculate(),t=e.union(t,n.attacks)}),e.each(this._getPieces(n),function(e){e.calculate(),r=r.concat(e.moves);if(e.type===3&&t.indexOf(e.idx)!==-1)return i._state.check=!0}),r.length===0&&(this._state.check?this._state.finished="checkmate":this._state.finished="stalemate"),this._state.board=this._fen.pieces,this._state.active_color=this._fen.activeColor,this._state.valid_moves=this._calculateValidMoves(),this._state},r.prototype._updateArray=function(e,t){var n,r,i;return n=this._posToIdx(e),r=this._board[n],this._board[n]=null,i=this._posToIdx(t),r.idx=i,this._board[i]=r,this._updateCastling(e,t)},r.prototype._updateCastling=function(t,n){switch(t){case"e1":if(n==="g1"&&e.contains(this._fen.castling,"K"))return this._board[this._posToIdx("f1")]=this._board[this._posToIdx("h1")],this._board[this._posToIdx("f1")].idx=this._posToIdx("f1"),this._board[this._posToIdx("h1")]=null;if(n==="c1"&&e.contains(this._fen.castling,"Q"))return this._board[this._posToIdx("d1")]=this._board[this._posToIdx("a1")],this._board[this._posToIdx("d1")].idx=this._posToIdx("d1"),this._board[this._posToIdx("a1")]=null;break;case"e8":if(n==="g8"&&e.contains(this._fen.castling,"k"))return this._board[this._posToIdx("f8")]=this._board[this._posToIdx("h8")],this._board[this._posToIdx("f8")].idx=this._posToIdx("f8"),this._board[this._posToIdx("h8")]=null;if(n==="c8"&&e.contains(this._fen.castling,"q"))return this._board[this._posToIdx("d8")]=this._board[this._posToIdx("a8")],this._board[this._posToIdx("d8")].idx=this._posToIdx("d8"),this._board[this._posToIdx("a8")]=null}},r.prototype.getCheckingPieces=function(){var t,n;return t=this._getCurrentColor(),n=this._getPieces(t*-1),e.filter(n,function(e){return e.checks&&e.checks.length>0})},r.prototype.isPinned=function(t){var n,r,i;n=this._getCurrentColor(),r=this._getPieces(n*-1),i=e.detect(r,function(e){return e.pinning&&e.pinning[t]});if(i)return e(i.pinning[t]).chain().clone().without(t).union(i.idx).value()},r.prototype.isAttacked=function(t){var n;return n=this._getCurrentColor(),e.detect(this._getPieces(n*-1),function(e){var n;return((n=e.attacks)!=null?n.indexOf(t):void 0)!==-1})},r.prototype.isProtected=function(t){var n;return n=this._getCurrentColor(),e.detect(this._getPieces(n*-1),function(e){return e.moves.indexOf(t)!==-1||e.attacks.indexOf(t)!==-1})},r.prototype.isEmpty=function(e){return!this._getPieceAt(e)},r.prototype.isOnBoard=function(e){return e>=0&&e<127&&(e&136)===0},r.prototype.canCastle=function(e){return this._fen.canCastle(e)},r.prototype.isEnPassant=function(e){var t,n;return t=this._fen.enPassant,t&&t!=="-"?(n=this._posToIdx(t),e===n):!1},r.prototype.getMoves=function(t){var n,r,i=this;return n=this._posToIdx(t),r=this._getPieceAt(n),r&&r.color===this._getCurrentColor()?e.map(r.moves,function(e){return i._idxToPos(e)}):[]},r.prototype.toString=function(){return this._fen.toString()},r}();var v={Fen:n,Board:d};typeof module!="undefined"?module.exports=v:this.rex=v}).call(this);